import * as mocha from 'mocha';
import * as chai from 'chai';
import chaiHttp = require('chai-http');
import {router} from '../router';
import {beforeEachDo} from '../../test/before-eachs';
import {log} from '../../logger/logger';
import * as assert from 'assert';
import {User} from '../../db/user.model';
import {userDAO} from '../../db/user-dao';

chai.use(chaiHttp);
const expect = chai.expect;

describe('LoginRouter', () =&gt; {

  beforeEachDo.connectTestToDatabase();

  it('should be able to login', (done) =&gt; {

    const user: User = {
      email: 'hans'
    };

    const plaintextPassword = 'Hello World';

    userDAO.create(user, plaintextPassword, (dbResp) =&gt; {

      expect(dbResp.error).to.be.null;

      chai.request(router)
          .post(`/api/v1/login`)
          .send({
            email: user.email,
            password: plaintextPassword
          })
          .then((resp: any) =&gt; {
            expect(resp.body.data.uid).to.equal(dbResp.data.uid);
            done();
          }, (err) =&gt; {
            log.error(err);
            assert(false);
            done();
          })
          .catch((err) =&gt; {
            throw err;
          });

    });

  });

  it('shouldnt be able to login with wrong password', (done) =&gt; {

    const user: User = {
      email: 'hans'
    };

    const plaintextPassword = 'Hello World';

    userDAO.create(user, plaintextPassword, (dbResp) =&gt; {

      expect(dbResp.error).to.be.null;

      chai.request(router)
          .post('/api/v1/login')
          .send({
            email: user.email,
            password: 'some wrong password'
          })
          .catch((err) =&gt; {
            expect(err.response.res.statusCode).to.equal(401);
            done();
          });
    });

  });

});
